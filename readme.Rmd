---
title: "Titanic_readme"
author: "Michal Rackiewicz"
date: "2023-09-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

### Load packages and data

```{r}
library(tidyverse)
library(Hmisc)
library(corrplot)
library(ggpol)
```

```{r titanic data}
train <- read_csv("./Data/train.csv", col_types = "nffcfnnncnf")
test <- read_csv("./Data/test.csv", col_types = "nffcfnnncnf")
```

### Exploratory data analysis

```{r}
str(train)
```

First we will look at the summary statistics for each variable

```{r}
summary(train)
```

Let us also check the distribution of the dependent variable. By doing this we get an idea of how balanced the data set is and whether we have to do something to balance groups before modeling.

```{r}
train %>% 
  select(Survived) %>% 
  group_by(Survived) %>% 
  summarise(n = n()) %>% 
  mutate(Freq = paste0(round(100 * n/sum(n), 1), "%"))
```

We also want to check for missing values.

```{r}
train %>% 
  summarise_all(list(~sum(is.na(.))))
```

We see that although "Age" is the only variable with missing values. We will replace blank cells and those containing only spaces, as well as zeros in Fare with NAs.

```{r}
train$Fare[train$Fare == 0] = NA
```

```{r}
train <- train %>% 
  mutate(across(everything(), ~gsub("^[[:space:]]*$", NA, .)))
```

```{r}
train %>% 
  summarise_all(list(~sum(is.na(.))))
```

Due to too many missing values, we will drop the Cabin column.

```{r}
train <- train %>% select(!Cabin)
```


## Data visualization
First, we will look at some basic plots of variable distributions and 

```{r numeric plots, echo=FALSE}
train %>% 
  select(where(is.numeric))%>%
  hist.data.frame(.)
```



```{r}
str(train)
```

```{r}
train <- train %>% 
  mutate(across(c(PassengerId, Age, SibSp, Parch, Fare), as.integer),
         across(c(Survived, Pclass, Embarked, Sex), as.factor)
         )
```

```{r}
pal_c <- wes_palette("GrandBudapest1", 21, type = "continuous")
```


Distributions of passenger IDs across passenger classes.

```{r}
train
ggplot(train, aes(x = PassengerId,
                  y = Pclass,
                  fill = Pclass)) +
  geom_jitter(shape = 21,
             color = "white") +
  labs(title = "Distirbution of passenger IDs",
       y = "Class",
       x = "Passenger ID",
       fill = "Passenger class") +
  theme_minimal()+
  scale_fill_manual(values = wes_palette("GrandBudapest1"))
```
Since the passenger IDs are distributed uniformly across all classes we will remove it as it holds no predictive value.


Let us also inspect the relationships between the variables. First, we will a plot a correlation map displaying linear relationship between the variables.
```{r}
correlation_matrix <- train %>%
  select(!c(Name, PassengerId, Ticket)) %>%
  mutate(across(where(is.factor), as.numeric)) %>%
  filter(complete.cases(.)) %>% 
  cor(as.matrix(.), method = "spearman")
```

```{r, echo=FALSE}
corrplot(correlation_matrix, 
         method = "square",
         type = "lower",
         order = "FPC",
         addCoef.col = 'black',
         diag = FALSE
         )
```
Correlation matrix with Age*Sex



Let us now take a closer look at those variables which are correlated with survival. As expected sex is a strong predictor of survival. Let us look at the numbers of survivors based on sex and passenger class.

```{r, echo=FALSE}
ggplot(train, 
       aes(x = interaction(Pclass, Sex),
           fill = Survived)) +
  geom_bar(stat="count",
           width = 0.4,
           position = position_dodge(width = 0.6)) +
  labs(title = "Survival based on Passenger Class and Sex",
       y = "Count",
       x = "Class/Sex",
       fill = "Survived") +
  theme_minimal()+
  scale_fill_manual(values = wes_palette("GrandBudapest1"))
```
We can infer that females - in general - are more likely to survive. Passenger class is also very import as we see a large proportion of deceased females passengers in the 3rd class with absolute number of female survivors across all three classes. For males the proportion of survivors is always skewed towards deceased. Male passengers in first class were much more likely to survive than in other classes. 

It is not apparent from the correlation map that age has any influence on survival. We do know however that children (and women) were more likely to be saved.
From this information we can already infer that the relationship between survival and age is not linear as the likelihood of survival does not increase with age.
Let us take a closer look at the distribution of survival rates across age for each sex.
```{r}
ggplot(train,
       aes(x = Age)) +
  geom_histogram(aes(fill = Survived,
                     bin = 50),
                 color = "black") +
  labs(title = "Age distribution of men in each class",
     y = "Age",
     x = "Class",
     fill = "Survived") +
  facet_grid(Sex ~ .) +
  theme_minimal() +
  scale_fill_manual(values = wes_palette("GrandBudapest1"))
```


Let us look at the age distribution for both sexes in each passenger class.
```{r}
train %>% 
  ggplot(aes(x = Pclass, 
             y = Age)) +
  geom_boxjitter(aes(fill = Survived),
                 position = position_dodge(width = 0.5),
                 width = 0.4,
                 jitter.shape = 21,
                 jitter.color = NA,
                 outlier.shape = 1,
                 errorbar.draw = TRUE,
                 errorbar.length = 0.4) +
  labs(title = "Age distribution of male passengers in each class",
       y = "Age",
       x = "Class",
       fill = "Survived") +
  facet_grid(~Sex) + 
  theme_minimal() +
  scale_fill_manual(values = wes_palette("GrandBudapest1"))
```

```{r}
train %>% 
  filter(Sex == "male") %>%
  ggplot(aes(x = Pclass, 
             y = Age)) +
  geom_boxjitter(aes(fill = Survived),
                 position = position_dodge(width = 0.8),
                 width = 0.3,
                 jitter.shape = 21,
                 jitter.color = NA,
                 outlier.shape = 1,
                 errorbar.draw = TRUE,
                 errorbar.length = 0.4)+
  labs(title = "Age distribution of male passengers in each class",
       y = "Age",
       x = "Class",
       fill = "Survived") +
  theme_minimal() +
  scale_fill_manual(values = wes_palette("GrandBudapest1"))
```

```{r}
train %>% 
  filter(Sex == "female") %>%
  ggplot(aes(x = Pclass, 
             y = Age)) +
  geom_boxjitter(aes(fill = Survived),
                 position = position_dodge(width = 0.8),
                 width = 0.3,
                 jitter.shape = 21,
                 jitter.color = NA,
                 outlier.shape = 1,
                 errorbar.draw = TRUE,
                 errorbar.length = 0.4) +
  labs(title = "Age distribution of female passengers in each class",
       y = "Age",
       x = "Class",
       fill = "Survived") +
  theme_minimal() +
  scale_fill_manual(values = wes_palette("GrandBudapest1"))
```

```{r}
train %>% 
  filter(Survived == 1) %>%
  ggplot(aes(x = Pclass, 
             y = Age)) +
  geom_boxjitter(aes(fill = Sex),
                 position = position_dodge(width = 0.8),
                 width = 0.3,
                 jitter.shape = 21,
                 jitter.color = NA,
                 outlier.shape = 1,
                 errorbar.draw = TRUE,
                 errorbar.length = 0.4) +
  labs(title = "Age of survivors based on Class and Sex",
       y = "Age",
       x = "Class",
       fill = "Sex") +
  theme_minimal() +
  scale_fill_manual(values = wes_palette("GrandBudapest1"))
```

Distribution of survivors based on the port of embarkation.
```{r}
train %>% 
  filter(complete.cases(.)) %>% 
  ggplot(aes(x = Embarked,
           fill = Survived)) +
    geom_bar() +
    labs(title = "Number of survivors per port of embarkation",
         y = "Count",
         x = "City",
         fill = "Survived") +
    theme_minimal() +
    scale_fill_manual(values = wes_palette("GrandBudapest1"))
  
```

```{r}
train %>% 
  filter(complete.cases(.)) %>%
  group_by(Embarked, Survived) %>%
  summarise(count = n()) %>%
  mutate(prop = count/sum(count)) %>%
  ggplot(aes(x = Embarked, y = prop, fill = Survived)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Proportion of survivors per port of embarkation",
       y = "Survivors [%]",
       x = "City",
       fill = "Survived") +
  theme_minimal() +
  scale_fill_manual(values = wes_palette("GrandBudapest1"))
```


It is apparent that the amount of survivors among the passengers embarking in Cherbourg is relatively higher than in Queenstown or Southhampton.
From the correlation plot we know that this variable is correlated with passenger class.

```{r}
train %>% 
  filter(complete.cases(.)) %>%
  group_by(Embarked, Pclass) %>%
  summarise(count = n()) %>%
  mutate(prop = count/sum(count)) %>%
  ggplot(aes(x = Embarked, y = prop, fill = Pclass)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Proportion of passengers in each class per port of embarkation",
       y = "Passengers [%]",
       x = "City",
       fill = "Class") +
  theme_minimal() +
  scale_fill_manual(values = wes_palette("GrandBudapest1"))
  
```
We see that among the passengers embarking in Cherbourg, the majority belonged to class 1, while the vast majority of people embarking in Queensland (with the lowest proportion of survivors) were 3rd class passengers.


```{r}
train %>% 
  filter(complete.cases(.)) %>%
  ggplot(aes(x = Parch, fill = Sex)) +
  geom_bar() +
  labs(title = "Proportion passengers in each class per port of embarkation",
       y = "Count",
       x = "# of parents / children",
       fill = "Sex") +
  theme_minimal() +
  scale_fill_manual(values = wes_palette("GrandBudapest1"))
```
Female passengers were more likely to travel with their parents/children.
Distribution of parch among classes.

```{r}
train %>% 
  filter(complete.cases(.)) %>%
  ggplot(aes(x = Parch, fill = Pclass)) +
  geom_bar(position = "dodge") +
  facet_grid(Sex ~ .) + 
  labs(title = "Numbers of passengers travelling with parents/children",
       y = "Count",
       x = "# of parents / children",
       fill = "Class") +
  theme_minimal() +
  scale_fill_manual(values = wes_palette("GrandBudapest1"))
```
Most passengers were travelling without their children/parents. The absolute numbers are higher in men and 3rd class passengers.


```{r}

```



Passenger class and fare are 
They are, however, strongly negatively correlated with each other, i.e. the highest fares are found in class 1.
```{r, echo=FALSE}
ggplot(train, aes(x = Pclass,
                  y = Fare,
                  fill = Pclass)) +
  geom_boxplot() +
  labs(title = "Fares per passenger class",
       y = "Fare",
       x = "Class") +
  theme_minimal()+
  scale_fill_manual(values = wes_palette("GrandBudapest1"))
```
We should therefore consider removing one or the other as autocorrelated variables are likely to skew our predictive model.


```{r}
train %>% 
  group_by(Survived) %>% 
  summarise(across(c(Pclass, Sex, SibSp, Parch, Embarked), ~n()))
  
```


